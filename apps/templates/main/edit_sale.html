{% extends "layouts/base.html" %}

{% block title %} Modifier Vente {% endblock %} {# Changed title #}

{% block content %}

    {# Render the Page Header #}
    {% set breadcrumb_items = [
        {'text': 'Ventes', 'url': url_for('main_bp.vente_stock')}
    ] %}
    {% if sale is defined and sale.id is not none %} {# Check if sale and sale.id exist #}
        {% set _ = breadcrumb_items.append({'text': 'Modifier Vente', 'url': url_for('main_bp.edit_sale', sale_id=sale.id)}) %}
    {% else %}
        {# Fallback if sale is not defined, e.g., for initial page load or error states where sale isn't passed #}
        {% set _ = breadcrumb_items.append({'text': 'Modifier Vente', 'url': '#'}) %}
    {% endif %}

    <div class="container-fluid mt--6">
        <div class="row">
            <div class="col-xl-12 order-xl-1">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <h3 class="mb-0">Modifier une Vente (ID: {{ sale.id }})</h3> {# Added Sale ID for clarity #}
                            </div>
                            <div class="col-4 text-right">
                                {# No "Add Sale" button needed on an edit page #}
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        {# THIS IS THE MOST CRUCIAL CHANGE: Update the form's action #}
                        <form method="post" action="{{ url_for('main_bp.edit_sale', sale_id=sale.id) }}">
                            {{ form.hidden_tag() }}

                            <h6 class="heading-small text-muted mb-4">Informations sur le Client</h6>
                            <div class="pl-lg-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group{% if form.client_choice.errors %} has-danger{% endif %}">
                                            {{ form.client_choice.label(class="form-control-label") }}
                                            {{ form.client_choice(class="form-control" + (" is-invalid" if form.client_choice.errors else ""), id="client-choice-select") }}
                                            {% for error in form.client_choice.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6" id="existing-client-field">
                                        <div class="form-group{% if form.existing_client_id.errors %} has-danger{% endif %}">
                                            {{ form.existing_client_id.label(class="form-control-label") }}
                                            {{ form.existing_client_id(class="form-control" + (" is-invalid" if form.existing_client_id.errors else "")) }}
                                            {% for error in form.existing_client_id.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="col-md-6" id="new-client-name-field" style="display: none;">
                                        <div class="form-group{% if form.new_client_name.errors %} has-danger{% endif %}">
                                            {{ form.new_client_name.label(class="form-control-label") }}
                                            {{ form.new_client_name(class="form-control" + (" is-invalid" if form.new_client_name.errors else "")) }}
                                            {% for error in form.new_client_name.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4" />
                            <h6 class="heading-small text-muted mb-4">Stock à Vendre</h6>
                            <div class="pl-lg-4">
                                <div id="sale-items-container">
                                    {# This loop will now render the pre-populated items on GET #}
                                    {# And the submitted items (with errors if any) on POST #}
                                    {% for item_field in form.sale_items %}
                                        <div class="form-row align-items-end mb-3 network-item-group" id="sale-item-{{ loop.index0 }}">
                                            {# Ensure 'form' attribute is checked for nested fields #}
                                            {% set current_item_form = item_field %}
                                            {% if item_field.form is defined %}
                                                {% set current_item_form = item_field.form %}
                                            {% endif %}

                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    {{ current_item_form.network.label(class="form-control-label") }}
                                                    {{ current_item_form.network(class="form-control" + (" is-invalid" if current_item_form.network.errors else "")) }} {# Added is-invalid class #}
                                                    {% for error in current_item_form.network.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    {{ current_item_form.quantity.label(class="form-control-label") }}
                                                    {{ current_item_form.quantity(class="form-control" + (" is-invalid" if current_item_form.quantity.errors else "")) }} {# Added is-invalid class #}
                                                    {% for error in current_item_form.quantity.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    {{ current_item_form.price_per_unit_applied.label(class="form-control-label") }}
                                                    {{ current_item_form.price_per_unit_applied(class="form-control" + (" is-invalid" if current_item_form.price_per_unit_applied.errors else "")) }} {# Added is-invalid class #}
                                                    {% for error in current_item_form.price_per_unit_applied.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-1">
                                                {# Placeholder for potential future display or removed entirely for simplicity #}
                                            </div>
                                            <div class="col-md-1">
                                                <button type="button" class="btn btn-danger btn-sm remove-sale-item-btn" {% if loop.index0 == 0 and form.sale_items|length == 1 %}disabled{% endif %}>
                                                {# Disable remove button only if it's the *only* item #}
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {# Removed duplicate error display, now integrated into the form-group div #}
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-sm btn-primary mt-3" id="add-sale-item-btn">Ajouter un article</button> {# More descriptive button text #}
                            </div>

                            <hr class="my-4" />
                            <h6 class="heading-small text-muted mb-4">Paiement</h6>
                            <div class="pl-lg-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group{% if form.cash_paid.errors %} has-danger{% endif %}">
                                            {{ form.cash_paid.label(class="form-control-label") }}
                                            {{ form.cash_paid(class="form-control" + (" is-invalid" if form.cash_paid.errors else "")) }}
                                            {% for error in form.cash_paid.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-right">
                                <a href="{{ url_for('main_bp.vente_stock') }}" class="btn btn-secondary my-4">Annuler</a> {# Add a Cancel button #}
                                {{ form.submit(class="btn btn-primary my-4", value="Mettre à jour la Vente") }} {# Changed button text #}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {# REMOVED: Table for displaying sales - This belongs in vente_stock.html #}
        {# The entire block below this line:
            <div class="row mt-5">
                <div class="col-xl-12">
                    <div class="card">
                        ... (all the sales table content) ...
                    </div>
                </div>
            </div>
        #}

        {# The cash edit modal should probably remain in vente_stock.html as well,
           unless you specifically want to update cash on the edit sale page.
           For a cleaner separation, consider moving it.
           For now, let's keep it if your workflow requires it on *this* page.
           If it's only for the sales list, move it. #}
        {% include "includes/footer.html" %}

    </div>

    {# MODAL for editing cash - Decide if this is needed here or only on vente_stock.html #}
    {# If you keep it, ensure the route '/update-sale-cash/<int:sale_id>' exists and handles it #}
    <div class="modal fade" id="editCashModal" tabindex="-1" role="dialog" aria-labelledby="editCashModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCashModalLabel">Mise à jour Paiement</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editCashForm" method="POST" action="">
                <div class="form-group">
                    <label for="new_cash_input">Paiement (FC):</label>
                    <input type="number" step="0.01" class="form-control" id="new_cash_input" name="new_cash" required>
                </div>
                <input type="hidden" name="sale_id_hidden" id="sale_id_hidden">
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
                </form>
            </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block javascripts %}
    {{ super() }}

    <script>
        $(document).ready(function() {
            // Client choice logic
            function toggleClientFields() {
                var clientChoice = $('#client-choice-select').val();
                if (clientChoice === 'existing') {
                    $('#existing-client-field').show();
                    $('#new-client-name-field').hide();
                } else if (clientChoice === 'new') {
                    $('#existing-client-field').hide();
                    $('#new-client-name-field').show();
                }
            }

            $('#client-choice-select').change(toggleClientFields);
            toggleClientFields(); // Call on load to set initial state

            // Add/Remove Sale Item fields
            $('#add-sale-item-btn').on('click', function() {
                var container = $('#sale-items-container');
                var currentCount = container.find('.network-item-group').length;

                // Max 4 items as per the simple requirement
                if (currentCount >= 4) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Limite d\'articles',
                        text: 'Vous ne pouvez ajouter que jusqu\'à 4 articles par vente pour l\'instant.',
                        confirmButtonText: 'Compris'
                    });
                    return;
                }

                // Simulate adding a new form entry by duplicating the last one and clearing values
                // Use a template for new items if possible for cleaner HTML cloning
                // For now, cloning the last is okay if it's the only one rendered
                var lastItem = container.find('.network-item-group').last();
                var newItem = lastItem.clone(true, true); // Clone with data and events

                var newIndex = currentCount; // The index for the new form field list entry

                // Update names and IDs for the cloned elements to match WTForms FieldList naming convention
                newItem.find('[name]').each(function() {
                    var oldName = $(this).attr('name');
                    if (oldName) {
                        // Regex to replace 'sale_items-X-' with 'sale_items-newIndex-'
                        var newName = oldName.replace(/sale_items-\d+-(.*)/, `sale_items-${newIndex}-$1`);
                        $(this).attr('name', newName);
                    }
                    var oldId = $(this).attr('id');
                    if (oldId) {
                        var newId = oldId.replace(/sale_items-\d+-(.*)/, `sale_items-${newIndex}-$1`);
                        $(this).attr('id', newId);
                    }
                    $(this).val(''); // Clear values for new fields
                    $(this).removeClass('is-invalid'); // Remove validation styles
                });
                newItem.find('.invalid-feedback').remove(); // Remove error messages

                // Enable the remove button for the new item and ensure first item always has it disabled
                newItem.find('.remove-sale-item-btn').prop('disabled', false);
                // After adding, re-evaluate all remove buttons
                container.find('.network-item-group').each(function(idx) {
                    if (idx === 0 && container.find('.network-item-group').length === 1) {
                        $(this).find('.remove-sale-item-btn').prop('disabled', true);
                    } else {
                        $(this).find('.remove-sale-item-btn').prop('disabled', false);
                    }
                });

                // Update data-index for the new row (useful for debugging, not strictly necessary for WTForms)
                newItem.attr('data-index', newIndex);
                newItem.attr('id', `sale-item-${newIndex}`);

                container.append(newItem);
            });


            $('#sale-items-container').on('click', '.remove-sale-item-btn', function() {
                var itemToRemove = $(this).closest('.network-item-group');
                var container = $('#sale-items-container');
                var currentCount = container.find('.network-item-group').length;

                if (currentCount > 1) {
                    itemToRemove.remove();
                    // Re-index remaining items after removal to maintain correct FieldList order
                    container.find('.network-item-group').each(function(index) {
                        $(this).attr('id', `sale-item-${index}`);
                        $(this).attr('data-index', index);
                        $(this).find('[name]').each(function() {
                            var oldName = $(this).attr('name');
                            if (oldName) {
                                var newName = oldName.replace(/sale_items-\d+-(.*)/, `sale_items-${index}-$1`);
                                $(this).attr('name', newName);
                            }
                            var oldId = $(this).attr('id');
                            if (oldId) {
                                var newId = oldId.replace(/sale_items-\d+-(.*)/, `sale_items-${index}-$1`);
                                $(this).attr('id', newId);
                            }
                        });
                    });

                    // Ensure the first item's remove button is disabled if only one remains
                    if (container.find('.network-item-group').length === 1) {
                        container.find('.network-item-group').first().find('.remove-sale-item-btn').prop('disabled', true);
                    } else {
                        // Re-enable all if there's more than one
                        container.find('.network-item-group').find('.remove-sale-item-btn').prop('disabled', false);
                    }
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'Impossible de supprimer',
                        text: 'Vous devez avoir au moins un article de vente.',
                        confirmButtonText: 'Compris'
                    });
                }
            });


            // Edit Cash Paid functionality - ONLY KEEP THIS IF you intend to update cash
            // directly from the *edit sale* page's context.
            // If cash updates are *only* done from the main sales list, remove this modal and JS.
            $('.btn-edit-cash').on('click', function() {
                var saleId = $(this).data('sale-id');
                var currentCash = $(this).data('current-cash');

                $('#sale_id_hidden').val(saleId); // Store sale ID in a hidden field
                $('#new_cash_input').val(currentCash); // Populate with current cash

                // Set the form action dynamically
                $('#editCashForm').attr('action', '/update-sale-cash/' + saleId); // Ensure this route exists in Flask

                $('#editCashModal').modal('show');
            });

            $('#editCashForm').on('submit', function(e) {
                // This will trigger a full page reload or an AJAX call to your Flask route
                // If you want AJAX, implement e.preventDefault() and a $.ajax call.
                // Otherwise, Flask's flash messages will handle feedback after redirect.
            });
        });
    </script>
{% endblock javascripts %}