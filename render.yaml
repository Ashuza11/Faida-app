# render.yaml - Render Blueprint for Faida App
# https://render.com/docs/blueprint-spec
#
# This uses Neon PostgreSQL (external) instead of Render's database
# for better free tier and serverless support.

services:
  - type: web
    name: Faida App
    runtime: docker

    # Docker configuration
    dockerfilePath: ./src/Dockerfile
    dockerContext: ./src

    # Plan (free tier available)
    plan: free

    # Region - closest to Central Africa
    region: frankfurt

    # Auto-deploy from main branch
    branch: main
    autoDeploy: true

    # Health check endpoint
    healthCheckPath: /health

    # Environment variables
    envVars:
      # Flask configuration
      - key: FLASK_APP
        value: run.py
      - key: FLASK_ENV
        value: production

      # Security - auto-generate secure key
      - key: SECRET_KEY
        generateValue: true

      # Database - Neon PostgreSQL (set manually in dashboard)
      # Copy your Neon production connection string here
      - key: DATABASE_URL
        sync: false # Must be set manually in Render dashboard

      # Python settings
      - key: PYTHON_VERSION
        value: "3.11"

      # Gunicorn workers
      - key: WEB_CONCURRENCY
        value: "2"

    # Build command (runs during build phase)
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt

    # Start command (runs when starting the service)
    # The entrypoint.sh handles migrations and initialization
    startCommand: ./entrypoint.sh

# ===========================================
# IMPORTANT: After deploying, you must:
# ===========================================
# 1. Go to Render Dashboard → Faida App service → Environment
# 2. Add DATABASE_URL with your Neon production connection string
# 3. Trigger a manual deploy or push a new commit
#
# Neon connection string format:
# postgresql://user:password@ep-xxx-xxx-pooler.region.aws.neon.tech/neondb?sslmode=require
#
# Make sure to use the POOLED connection string (-pooler in hostname)
# ===========================================
