# render.yaml
# Render Blueprint - Infrastructure as Code
# https://render.com/docs/blueprint-spec

services:
  # ===========================================
  # Web Service - Main Flask Application
  # ===========================================
  - type: web
    name: faida-app
    runtime: docker
    
    # Docker configuration
    dockerfilePath: ./src/Dockerfile
    dockerContext: ./src
    
    # Build settings
    plan: free  # Options: free, starter, standard, pro
    region: frankfurt  # Closest to Central Africa
    
    # Branch to deploy
    branch: main
    
    # Auto-deploy on push
    autoDeploy: true
    
    # Health check
    healthCheckPath: /health
    
    # Environment variables
    envVars:
      - key: FLASK_ENV
        value: production
      - key: FLASK_APP
        value: run.py
      - key: SECRET_KEY
        generateValue: true  # Render generates a secure random value
      - key: DATABASE_URL
        fromDatabase:
          name: airtfast-db
          property: connectionString
      # Or use Neon DB instead:
      # - key: DATABASE_URL
      #   sync: false  # Set manually in dashboard
      - key: PYTHON_VERSION
        value: "3.11"
      - key: WEB_CONCURRENCY
        value: "2"
      
    # Build command
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    
    # Start command
    startCommand: |
      flask db upgrade && gunicorn --config gunicorn-cfg.py run:app

  # ===========================================
  # Background Worker (Optional)
  # ===========================================
  # - type: worker
  #   name: faida-worker
  #   runtime: docker
  #   dockerfilePath: ./src/Dockerfile
  #   dockerContext: ./src
  #   envVars:
  #     - fromGroup: faida-env
  #   startCommand: celery -A apps.celery worker --loglevel=info

# ===========================================
# Database (if using Render PostgreSQL)
# ===========================================
databases:
  - name: airtfast-db
    plan: free  # 90 days free, then $7/month
    databaseName: airtfast
    user: airtfast_user
    region: frankfurt

# ===========================================
# Environment Variable Groups
# ===========================================
envVarGroups:
  - name: airtfast-env
    envVars:
      - key: FLASK_ENV
        value: production
      - key: LOG_LEVEL
        value: INFO