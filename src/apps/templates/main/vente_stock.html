{% extends "layouts/base.html" %}
{% import "includes/_filters.html" as filters %}

{% block title %} Vente Stock {% endblock %}

{% block content %}

    {# Render the Page Header #}
    {% set page_title = 'Gestion Ventes' %}
    {% set breadcrumb_items = [
        {'text': 'Ventes', 'url': url_for('main_bp.vente_stock')},
        {'text': 'Nouvelle Vente', 'url': url_for('main_bp.vente_stock')}
    ] %}
    {% include 'includes/page_header.html' %}

    <div class="container-fluid mt--6">
        <div class="row">
            <div class="col-xl-12 order-xl-1">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <h3 class="mb-0">Enregistrer une Nouvelle Vente</h3>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{{ url_for('main_bp.vente_stock') }}">
                            {{ form.hidden_tag() }}

                            <h6 class="heading-small text-muted mb-4">Informations sur le Client</h6>
                            <div class="pl-lg-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group{% if form.client_choice.errors %} has-danger{% endif %}">
                                            {{ form.client_choice.label(class="form-control-label") }}
                                            {{ form.client_choice(class="form-control" + (" is-invalid" if form.client_choice.errors else ""), id="client-choice-select") }}
                                            {% for error in form.client_choice.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6" id="existing-client-field">
                                        <div class="form-group{% if form.existing_client_id.errors %} has-danger{% endif %}">
                                            {{ form.existing_client_id.label(class="form-control-label") }}
                                            {{ form.existing_client_id(class="form-control" + (" is-invalid" if form.existing_client_id.errors else "")) }}
                                            {% for error in form.existing_client_id.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="col-md-6" id="new-client-name-field" style="display: none;">
                                        <div class="form-group{% if form.new_client_name.errors %} has-danger{% endif %}">
                                            {{ form.new_client_name.label(class="form-control-label") }}
                                            {{ form.new_client_name(class="form-control" + (" is-invalid" if form.new_client_name.errors else "")) }}
                                            {% for error in form.new_client_name.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4" />
                            <h6 class="heading-small text-muted mb-4">Stock à Vendre</h6>
                            <div class="pl-lg-4">
                                <div id="sale-items-container">
                                    {% for item_field in form.sale_items %}
                                        <div class="form-row align-items-end mb-3 network-item-group" id="sale-item-{{ loop.index0 }}">
                                            {% set current_item_form = item_field %}
                                            {% if item_field.form is defined %}
                                                {% set current_item_form = item_field.form %}
                                            {% endif %}

                                            <div class="col-md-3">
                                                <div class="form-group">
                                                    {{ current_item_form.network.label(class="form-control-label") }}
                                                    {{ current_item_form.network(class="form-control") }}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    {{ current_item_form.quantity.label(class="form-control-label") }}
                                                    {{ current_item_form.quantity(class="form-control") }}
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-group">
                                                    {{ current_item_form.price_per_unit_applied.label(class="form-control-label") }}
                                                    {{ current_item_form.price_per_unit_applied(class="form-control") }}
                                                </div>
                                            </div>
                                            <div class="col-md-1">
                                                {# Placeholder for potential future display or removed entirely for simplicity #}
                                            </div>
                                            <div class="col-md-1">
                                                <button type="button" class="btn btn-danger btn-sm remove-sale-item-btn" {% if loop.index0 == 0 %}disabled{% endif %}>
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {# Display errors for fields within the item form #}
                                            {% for error in current_item_form.network.errors %} <div class="text-danger d-block col-12">{{ error }}</div> {% endfor %}
                                            {% for error in current_item_form.quantity.errors %} <div class="text-danger d-block col-12">{{ error }}</div> {% endfor %}
                                            {% for error in current_item_form.price_per_unit_applied.errors %} <div class="text-danger d-block col-12">{{ error }}</div> {% endfor %}
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-sm btn-primary mt-3" id="add-sale-item-btn">Ajouter</button>
                            </div>

                            <hr class="my-4" />
                            <h6 class="heading-small text-muted mb-4">Paiement</h6>
                            <div class="pl-lg-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group{% if form.cash_paid.errors %} has-danger{% endif %}">
                                            {{ form.cash_paid.label(class="form-control-label") }}
                                            {{ form.cash_paid(class="form-control" + (" is-invalid" if form.cash_paid.errors else "")) }}
                                            {% for error in form.cash_paid.errors %}
                                                <div class="invalid-feedback d-block">{{ error }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-right">
                                {{ form.submit(class="btn btn-primary my-4") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {# Table for displaying sales #}
        <div class="row mt-5">
            <div class="col-xl-12">
                <div class="card">
                    <div class="card-header border-0">
                        <div class="d-flex align-items-center justify-content-between flex-wrap" style="gap:10px;">
                            <h3 class="mb-0">Historique des Ventes</h3>
                            <div class="d-flex align-items-center flex-wrap" style="gap:8px;">
                                <!-- Date filter -->
                                <form method="GET" action="{{ url_for('main_bp.vente_stock') }}" class="m-0">
                                    <input type="date"
                                           name="date"
                                           value="{{ selected_date }}"
                                           class="form-control form-control-sm bg-white"
                                           style="height:36px;"
                                           onchange="this.form.submit()">
                                </form>
                                <!-- Live client search (filters rows on this page) -->
                                <div class="input-group input-group-sm" style="width:200px;">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-white border-right-0">
                                            <i class="fas fa-search text-muted" style="font-size:12px;"></i>
                                        </span>
                                    </div>
                                    <input id="vente-client-search"
                                           type="text"
                                           class="form-control border-left-0"
                                           placeholder="Chercher client…"
                                           autocomplete="off"
                                           style="height:36px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table align-items-center table-flush">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Client</th>
                                    <th scope="col">Vendeur</th>
                                    <th scope="col">Détails des Articles</th>
                                    <th scope="col">Total Dû (FC)</th>
                                    <th scope="col">Argent Donné (FC)</th>
                                    <th scope="col">Dette (FC)</th>
                                    <th scope="col">Date & Heure</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sales-history-tbody">
                            {% for sale in sales_pagination.items %} 
                                    <tr>
                                        <td>{{ sale.id }}</td>
                                        <td>{{ sale.client.name if sale.client else sale.client_name_adhoc }}</td>
                                        <td>{{ sale.seller.username }}</td>
                                        <td>
                                            {% for item in sale.sale_items %}
                                                <div>
                                                    <strong>{{ item.network.value|capitalize }}:</strong> {{ item.quantity }} unités @ {{ "{:,.2f}".format(item.price_per_unit_applied) }} FC
                                                    - Sous-total: {{ "{:,.2f}".format(item.subtotal) }} FC
                                                </div>
                                            {% endfor %}
                                        </td>
                                        <td>{{ "{:,.2f}".format(sale.total_amount_due) }}</td>
                                        <td>
                                            <span id="cash-paid-{{ sale.id }}">{{ "{:,.2f}".format(sale.cash_paid) }}</span>
                                            <button type="button" class="btn btn-sm btn-info btn-edit-cash ml-2" data-sale-id="{{ sale.id }}" data-current-cash="{{ sale.cash_paid }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                        <td><span id="debt-amount-{{ sale.id }}">{{ "{:,.2f}".format(sale.debt_amount) }}</span></td>
                                        <td>{{ sale.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <div class="dropdown">
                                                <a class="btn btn-sm btn-icon-only text-light" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <i class="fas fa-ellipsis-v" style="color:#5e72e4"></i>
                                                </a>
                                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-arrow">
                                                    <a class="dropdown-item" href="{{ url_for('main_bp.view_sale_details', sale_id=sale.id) }}">Détails</a>
                                                    <a class="dropdown-item" href="{{ url_for('main_bp.edit_sale', sale_id=sale.id) }}">Modifier</a>
                                                    <a class="dropdown-item text-danger" href="{{ url_for('main_bp.delete_sale', sale_id=sale.id) }}">Supprimer</a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="9" class="text-center">Aucune vente enregistrée.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {# Pass the pagination object (e.g. sales_pagination) and the endpoint name #}
                    {{ filters.render_pagination(sales_pagination, 'main_bp.vente_stock') }}
                </div>
            </div>
        </div>

        {% include "includes/footer.html" %}

    </div>

    <div class="modal fade" id="editCashModal" tabindex="-1" role="dialog" aria-labelledby="editCashModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCashModalLabel">Mise à jour Paiement</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editCashForm" method="POST" action="">
                <div class="form-group">
                    <label for="new_cash_input">Paiement (FC):</label>
                    <input type="number" step="0.01" class="form-control" id="new_cash_input" name="new_cash" required>
                </div>
                <input type="hidden" name="sale_id_hidden" id="sale_id_hidden">
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
                </form>
            </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block javascripts %}
    {{ super() }} 

    <script>
        $(document).ready(function() {
            // Client choice logic
            function toggleClientFields() {
                var clientChoice = $('#client-choice-select').val();
                if (clientChoice === 'existing') {
                    $('#existing-client-field').show();
                    $('#new-client-name-field').hide();
                } else if (clientChoice === 'new') {
                    $('#existing-client-field').hide();
                    $('#new-client-name-field').show();
                }
            }

            $('#client-choice-select').change(toggleClientFields);
            toggleClientFields(); // Call on load to set initial state

            // Add/Remove Sale Item fields
            $('#add-sale-item-btn').on('click', function() {
                var container = $('#sale-items-container');
                var currentCount = container.find('.network-item-group').length;

                // Max 4 items as per the simple requirement
                if (currentCount >= 4) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Limite d\'articles',
                        text: 'Vous ne pouvez ajouter que jusqu\'à 4 articles par vente pour l\'instant.',
                        confirmButtonText: 'Compris'
                    });
                    return;
                }

                // Simulate adding a new form entry by duplicating the last one and clearing values
                var lastItem = container.find('.network-item-group').last();
                var newItem = lastItem.clone();

                var newIndex = currentCount; // The index for the new form field list entry

                // Update names and IDs for the cloned elements to match WTForms FieldList naming convention
                newItem.find('[name]').each(function() {
                    var oldName = $(this).attr('name');
                    if (oldName) {
                        // Regex to replace 'sale_items-X-' with 'sale_items-newIndex-'
                        var newName = oldName.replace(/sale_items-\d+-(.*)/, `sale_items-${newIndex}-$1`);
                        $(this).attr('name', newName);
                    }
                    var oldId = $(this).attr('id');
                    if (oldId) {
                        var newId = oldId.replace(/sale_items-\d+-(.*)/, `sale_items-${newIndex}-$1`);
                        $(this).attr('id', newId);
                    }
                    $(this).val(''); // Clear values for new fields
                    $(this).removeClass('is-invalid'); // Remove validation styles
                });
                newItem.find('.invalid-feedback').remove(); // Remove error messages

                // Enable the remove button for the new item and ensure first item always has it disabled
                newItem.find('.remove-sale-item-btn').prop('disabled', false);
                container.find('.network-item-group').first().find('.remove-sale-item-btn').prop('disabled', true);

                // Update data-index for the new row (useful for debugging, not strictly necessary for WTForms)
                newItem.attr('data-index', newIndex);
                newItem.attr('id', `sale-item-${newIndex}`);

                container.append(newItem);
            });


            $('#sale-items-container').on('click', '.remove-sale-item-btn', function() {
                var itemToRemove = $(this).closest('.network-item-group');
                var container = $('#sale-items-container');
                var currentCount = container.find('.network-item-group').length;

                if (currentCount > 1) {
                    itemToRemove.remove();
                    // Re-index remaining items after removal to maintain correct FieldList order
                    container.find('.network-item-group').each(function(index) {
                        $(this).attr('id', `sale-item-${index}`);
                        $(this).attr('data-index', index);
                        $(this).find('[name]').each(function() {
                            var oldName = $(this).attr('name');
                            if (oldName) {
                                var newName = oldName.replace(/sale_items-\d+-(.*)/, `sale_items-${index}-$1`);
                                $(this).attr('name', newName);
                            }
                            var oldId = $(this).attr('id');
                            if (oldId) {
                                var newId = oldId.replace(/sale_items-\d+-(.*)/, `sale_items-${index}-$1`);
                                $(this).attr('id', newId);
                            }
                        });
                    });

                    // Ensure the first item's remove button is disabled if only one remains
                    if (container.find('.network-item-group').length === 1) {
                        container.find('.network-item-group').first().find('.remove-sale-item-btn').prop('disabled', true);
                    }
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'Impossible de supprimer',
                        text: 'Vous devez avoir au moins un article de vente.',
                        confirmButtonText: 'Compris'
                    });
                }
            });


            // Edit Cash Paid functionality
            $('.btn-edit-cash').on('click', function() {
                var saleId = $(this).data('sale-id');
                var currentCash = $(this).data('current-cash');

                $('#sale_id_hidden').val(saleId); // Store sale ID in a hidden field
                $('#new_cash_input').val(currentCash); // Populate with current cash
                
                // Set the form action dynamically
                $('#editCashForm').attr('action', '/update-sale-cash/' + saleId);

                $('#editCashModal').modal('show');
            });

            // Edit cash form submits normally
            $('#editCashForm').on('submit', function(e) {});
        });
    </script>

    <!-- Live client search for the sales history table -->
    <script>
    (function () {
      var input = document.getElementById('vente-client-search');
      if (!input) return;

      // The sales table tbody (second table on the page)
      var tbody = document.querySelector('#sales-history-tbody');

      input.addEventListener('input', function () {
        var q = this.value.trim().toLowerCase();
        var rows = tbody ? tbody.querySelectorAll('tr:not(.faida-no-result)') : [];
        var visible = 0;

        rows.forEach(function (row) {
          // Client name is in the 2nd <td>
          var clientCell = row.querySelector('td:nth-child(2)');
          var text = clientCell ? clientCell.textContent.toLowerCase() : row.textContent.toLowerCase();
          var match = !q || text.includes(q);
          row.style.display = match ? '' : 'none';
          if (match) visible++;
        });

        // No-results feedback
        var nr = tbody ? tbody.querySelector('.faida-no-result') : null;
        if (!q || visible > 0) {
          if (nr) nr.remove();
        } else {
          if (!nr && tbody) {
            nr = document.createElement('tr');
            nr.className = 'faida-no-result';
            nr.innerHTML = '<td colspan="9" class="text-center text-muted py-3">' +
              '<i class="fas fa-search mr-2"></i>Aucun client "<strong>' +
              q.replace(/</g, '&lt;') + '</strong>" trouvé sur cette page</td>';
            tbody.appendChild(nr);
          }
        }
      });
    })();
    </script>
{% endblock javascripts %}